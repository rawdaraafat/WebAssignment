{% extends 'main/bars.html' %}
{% load static %}

{% block content %}
<div class="container">
    <div class="book-details">
        <div class="book-cover">
            {% if book.cover_image %}
                <img src="{{ book.cover_image.url }}" alt="{{ book.title }}">
            {% else %}
                <img src="{% static 'imgs/default-book-cover.jpg' %}" alt="Default Cover">
            {% endif %}
        </div>
        <div class="book-info">
            <h1>{{ book.title }}</h1>
            <h2>By {{ book.author }}</h2>
            <div class="book-meta">
                <p><strong>Genre:</strong> {{ book.get_genre_display }}</p>
                <p><strong>Publisher:</strong> {{ book.publisher }}</p>
                <p><strong>Publication Date:</strong> {{ book.publication_date }}</p>
                <p><strong>ISBN:</strong> {{ book.isbn }}</p>
                <p><strong>Status:</strong> <span class="status {{ book.status }}">{{ book.get_status_display }}</span></p>
                <p><strong>Available Copies:</strong> {{ book.quantity }}</p>
            </div>
            <div class="book-description">
                <h3>Description</h3>
                <p>{{ book.description }}</p>
            </div>
            <div class="book-actions">
                {% if user.is_authenticated %}
                    <a href="#" class="btn Purchase">Buy</a>
                    <a href="#" class="btn Borrow">Borrow</a>
                    <a href="#" class="btn fav">Add to Favorites</a>
                {% else %}
                    <a href="{% url 'main:login' %}" class="btn">Login to Buy/Borrow</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // Add event listeners for the buttons
    document.querySelector('.Purchase')?.addEventListener('click', () => {
        let cartBooks = JSON.parse(localStorage.getItem("Cart")) || [];
        if (!(cartBooks.some(elm => elm.title == "{{ book.title }}"))) {
            cartBooks.push({
                title: "{{ book.title }}",
                author: "{{ book.author }}",
                image: "{% if book.cover_image %}{{ book.cover_image.url }}{% else %}{% static 'imgs/default-book-cover.jpg' %}{% endif %}",
                book_id: "{{ book.id }}"
            });
            localStorage.setItem("Cart", JSON.stringify(cartBooks));
        }
    });

    document.querySelector('.Borrow')?.addEventListener('click', () => {
        let borrowed = JSON.parse(localStorage.getItem("Borrowed")) || [];
        if (!(borrowed.some(elm => elm.title == "{{ book.title }}"))) {
            let dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 7);
            borrowed.push({
                title: "{{ book.title }}",
                author: "{{ book.author }}",
                image: "{% if book.cover_image %}{{ book.cover_image.url }}{% else %}{% static 'imgs/default-book-cover.jpg' %}{% endif %}",
                book_id: "{{ book.id }}",
                dueDate: dueDate
            });
            localStorage.setItem("Borrowed", JSON.stringify(borrowed));
        }
    });

    document.querySelector('.fav')?.addEventListener('click', () => {
        let favs = JSON.parse(localStorage.getItem("Favorites")) || [];
        if (!(favs.some(elm => elm.title == "{{ book.title }}"))) {
            favs.push({
                title: "{{ book.title }}",
                author: "{{ book.author }}",
                image: "{% if book.cover_image %}{{ book.cover_image.url }}{% else %}{% static 'imgs/default-book-cover.jpg' %}{% endif %}",
                book_id: "{{ book.id }}"
            });
            localStorage.setItem("Favorites", JSON.stringify(favs));
        }
    });
</script>
{% endblock %}
